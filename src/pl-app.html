<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">

<link rel="import" href="./pl-header.html">
<link rel="import" href="./pl-editor.html">
<link rel="import" href="./pl-desc-dialog.html">
<link rel="import" href="./pl-level-selector.html">
<script src="./polylearn.js">
</script>

<dom-module id="pl-app">
  <template>
    <style>
      :host {
        display: block;
        height: 100vh;
        width: 100vw;
      }

      #container {
        height: calc(100vh - 54px);
        display: flex;
        justify-content: space-around;;
      }

      pl-editor {
        flex: 1;
        height: calc(100vh - 48px);
      }

      #resultWindowContainer {
        flex: 1;
        border-left: 1px solid #aaa;
        position: relative;
      }

      #resultWindowContainer iframe {
        border: 0;
        height: 100%;
        width: 100%;
      }

      #testWindow {
        0px 2px 1px 0px #ccc;
        overflow: auto;
        position: absolute;
        top: 0;
        right: 0;
        left: 0;
        bottom: 50%;
        z-index: 1;
      }

      app-drawer {
        z-index: 9;
      }
    </style>
    <iron-ajax
      id="ajax"
      auto
      handle-as="text"
      on-response="_handleResponse"></iron-ajax>


    <pl-header on-tap-run-view="runView"
               on-tap-watch-desc="watchDesc"
               on-tap-run-test="runTest"
               on-tap-change-level="_toggleDrawer"></pl-header>

     <div id="container">
       <pl-editor id="plEditor"></pl-editor>
       <div id="resultWindowContainer">
         <!-- <iframe id="iframe"></iframe> -->
         <!-- <div id="testWindow">
           <iframe src="/run_test.html" width="600" height="600"></iframe>
         </div> -->
       </div>
     </div>

    <pl-desc-dialog id="descDialog"></pl-desc-dialog>

     <app-drawer id="drawer" swipe-open>
       <pl-level-selector></pl-level-selector>
     </app-drawer>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'pl-app',

        properties: {},

        attached() {
          this.$.ajax.url = 'level01/level01.html';
        },

        get iframe() {
          return this.$$('iframe');
        },

        get testIframe() {
          return this.$$('#testWindow>iframe');
        },

        _handleResponse() {
          this.$.plEditor.setEditorValue(this.$.ajax.lastResponse);
        },

        _reloadIFrame(iframe) {
          if (this.iframe) {
            Polymer.dom(this.$.resultWindowContainer).removeChild(this.iframe);
          }
          Polymer.dom(this.$.resultWindowContainer).appendChild(iframe);
        },

        runTest() {
          let html = this.$.plEditor.getEditorValue();
          let iframe = window.Polylearn.createTestIframe(html);
          this._reloadIFrame(iframe);
        },

        runView() {
          let html = this.$.plEditor.getEditorValue();
          let iframe = window.Polylearn.createPreviewIframe(html);
          this._reloadIFrame(iframe);
        },

        watchDesc() {
          this.$.descDialog.mdFile = 'level01/level01.md';
          this.$.descDialog.opened = true;
        },

        _toggleDrawer() {
          this.$.drawer.toggle();
        }
      });
    })();
  </script>
</dom-module>